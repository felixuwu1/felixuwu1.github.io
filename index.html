<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Esc치ner Inteligente de Recibos</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

<style>
body{
  font-family: Arial;
  background:#f2f2f2;
  padding:20px;
}
h1{text-align:center;}

input,button{
  padding:8px;
  margin-top:10px;
}

.card{
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
  position:relative;
}

.delete{
  position:absolute;
  right:10px;
  top:10px;
  background:red;
  color:white;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>

<h1>Esc치ner Inteligente de Recibos</h1>

<input type="file" id="fileInput" accept="image/*,.pdf">
<button onclick="procesar()">Escanear Documento</button>

<h2>Registros Guardados</h2>
<div id="contenedor"></div>

<script>

let registros = JSON.parse(localStorage.getItem("registros")) || [];
mostrar();

async function procesar(){
  const file = document.getElementById("fileInput").files[0];
  if(!file){ alert("Selecciona un archivo"); return; }

  if(file.type === "application/pdf"){
    const reader = new FileReader();
    reader.onload = async function(){
      const typedarray = new Uint8Array(this.result);
      const pdf = await pdfjsLib.getDocument(typedarray).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 2 });

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({canvasContext:context,viewport:viewport}).promise;
      escanear(canvas);
    }
    reader.readAsArrayBuffer(file);
  }else{
    const reader = new FileReader();
    reader.onload = function(){
      const img = new Image();
      img.src = reader.result;
      img.onload = function(){ escanear(img); }
    }
    reader.readAsDataURL(file);
  }
}

async function escanear(imagen){
  alert("Escaneando... espera");

  const { data:{text} } = await Tesseract.recognize(imagen,'spa');

  extraerDatos(text);
}

function extraerDatos(texto){

  let fecha = texto.match(/\d{2}\/\d{2}\/\d{4}/);
  let total = texto.match(/\$\s?\d+[.,]?\d*/);
  let servicio = texto.match(/servicio\s*[:\-]?\s*(\d+)/i);
  let nombre = texto.match(/nombre\s*[:\-]?\s*([A-Z\s]+)/i);
  let direccion = texto.match(/direcci[o칩]n\s*[:\-]?\s*(.*)/i);

  let registro = {
    fecha: fecha ? fecha[0] : "No detectado",
    total: total ? total[0] : "No detectado",
    servicio: servicio ? servicio[1] : "No detectado",
    nombre: nombre ? nombre[1] : "No detectado",
    direccion: direccion ? direccion[1] : "No detectado"
  };

  registros.push(registro);
  localStorage.setItem("registros",JSON.stringify(registros));
  mostrar();
}

function mostrar(){
  const contenedor = document.getElementById("contenedor");
  contenedor.innerHTML="";

  registros.forEach((r,i)=>{
    contenedor.innerHTML+=`
    <div class="card">
      <button class="delete" onclick="borrar(${i})">X</button>
      <b>Nombre:</b> ${r.nombre}<br>
      <b>Servicio:</b> ${r.servicio}<br>
      <b>Fecha:</b> ${r.fecha}<br>
      <b>Total:</b> ${r.total}<br>
      <b>Direcci칩n:</b> ${r.direccion}
    </div>
    `;
  });
}

function borrar(i){
  registros.splice(i,1);
  localStorage.setItem("registros",JSON.stringify(registros));
  mostrar();
}

</script>

</body>
</html>
