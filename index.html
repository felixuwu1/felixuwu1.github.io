<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Escáner Profesional Recibo CFE</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
</script>

<!-- Tesseract OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
body{
  font-family:Arial;
  background:#f0f2f5;
  padding:20px;
}

.card{
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
}

button{
  padding:8px 12px;
  margin:5px;
  background:#2980b9;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

button:hover{
  background:#1f6391;
}

.resultado{
  margin-top:20px;
  background:#f9f9f9;
  padding:15px;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="card">
<h2>Escáner Profesional Recibo CFE</h2>

<input type="file" id="archivo" accept="application/pdf">
<button onclick="leerPDF()">Escanear Recibo</button>

<div id="estado"></div>
<div id="resultado"></div>

</div>

<script>

async function leerPDF(){

const archivo=document.getElementById("archivo").files[0];
if(!archivo){
alert("Selecciona un PDF");
return;
}

document.getElementById("estado").innerHTML="Escaneando... puede tardar 20-40 segundos";

const reader=new FileReader();

reader.onload=async function(){

try{

const typedarray=new Uint8Array(this.result);
const pdf=await pdfjsLib.getDocument(typedarray).promise;

let textoCompleto="";

for(let i=1;i<=pdf.numPages;i++){

const pagina=await pdf.getPage(i);
const viewport=pagina.getViewport({scale:2});

const canvas=document.createElement("canvas");
const context=canvas.getContext("2d");

canvas.height=viewport.height;
canvas.width=viewport.width;

await pagina.render({
canvasContext:context,
viewport:viewport
}).promise;

const imageData=canvas.toDataURL("image/png");

const {data:{text}}=await Tesseract.recognize(imageData,'spa',{
logger:m=>console.log(m)
});

textoCompleto+=text+" ";
}

extraerDatos(textoCompleto);

}catch(error){
document.getElementById("estado").innerHTML="Error al procesar PDF";
console.error(error);
}

};

reader.readAsArrayBuffer(archivo);
}

function extraerDatos(text){

text=text.replace(/\n/g," ").replace(/\s+/g," ");

function buscar(regex){
const match=text.match(regex);
return match?match[0]:"No detectado";
}

const datos={

numeroServicio:buscar(/\d{12}/),
periodo:buscar(/\d{2}\/\d{2}\/\d{4}\s*-\s*\d{2}\/\d{2}\/\d{4}/),
consumo:buscar(/\d+\s?kWh/i),
tarifa:buscar(/Tarifa\s?[A-Z0-9]+/i),
medidor:buscar(/Medidor\s?\d+/i),
total:buscar(/\$\s?\d{1,3}(,\d{3})*(\.\d{2})/),
fechaLimite:buscar(/Fecha\s*l[ií]mite\s*\d{2}\/\d{2}\/\d{4}/i)

};

mostrar(datos);
}

function mostrar(d){

document.getElementById("estado").innerHTML="Escaneo terminado ✔";

document.getElementById("resultado").innerHTML=`
<div class="resultado">
<b>No. Servicio:</b> ${d.numeroServicio}<br><br>
<b>Periodo:</b> ${d.periodo}<br><br>
<b>Consumo:</b> ${d.consumo}<br><br>
<b>Tarifa:</b> ${d.tarifa}<br><br>
<b>Medidor:</b> ${d.medidor}<br><br>
<b>Total:</b> ${d.total}<br><br>
<b>Fecha Límite:</b> ${d.fechaLimite}
</div>
`;
}

</script>

</body>
</html>
