<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Escáner Recibo CFE</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
</script>

<!-- Tesseract -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
body{
font-family:Arial;
background:#f0f2f5;
padding:20px;
}

.card{
background:white;
padding:20px;
border-radius:10px;
box-shadow:0 4px 8px rgba(0,0,0,0.1);
max-width:900px;
margin:auto;
}

button{
padding:10px 15px;
margin:10px 0;
background:#2980b9;
color:white;
border:none;
border-radius:6px;
cursor:pointer;
}

button:hover{
background:#1f6391;
}

.resultado{
background:#f9f9f9;
padding:15px;
margin-top:15px;
border-radius:8px;
white-space:pre-wrap;
}

canvas{
display:none;
}
</style>
</head>

<body>

<div class="card">
<h2>Escáner Recibo CFE</h2>

<input type="file" id="archivo" accept="application/pdf">
<br>
<button onclick="procesar()">Escanear Recibo</button>

<div id="estado"></div>
<div id="datos" class="resultado"></div>
<div id="textoOCR" class="resultado"></div>

</div>

<script>

async function procesar(){

const archivo = document.getElementById("archivo").files[0];
if(!archivo){
alert("Selecciona un PDF");
return;
}

document.getElementById("estado").innerHTML="Procesando... espera 20-40 segundos";

const reader = new FileReader();

reader.onload = async function(){

const typedarray = new Uint8Array(this.result);
const pdf = await pdfjsLib.getDocument({data:typedarray}).promise;

let textoTotal = "";

for(let i=1;i<=pdf.numPages;i++){

const page = await pdf.getPage(i);
const viewport = page.getViewport({scale:3});

const canvas = document.createElement("canvas");
const context = canvas.getContext("2d");

canvas.width = viewport.width;
canvas.height = viewport.height;

await page.render({
canvasContext: context,
viewport: viewport
}).promise;

// Convertir a imagen
const imageData = canvas.toDataURL("image/png");

// OCR
const result = await Tesseract.recognize(
imageData,
"spa",
{
logger: m => console.log(m)
}
);

textoTotal += result.data.text + " ";
}

extraerDatos(textoTotal);

};

reader.readAsArrayBuffer(archivo);
}

function extraerDatos(text){

text = text.replace(/\n/g," ").replace(/\s+/g," ");

function buscar(regex){
const match = text.match(regex);
return match ? match[0] : "No detectado";
}

const datos = {
numeroServicio: buscar(/\d{12}/),
periodo: buscar(/\d{2}\/\d{2}\/\d{4}\s*-\s*\d{2}\/\d{2}\/\d{4}/),
consumo: buscar(/\d+\s?kWh/i),
total: buscar(/\$\s?\d{1,3}(,\d{3})*(\.\d{2})/)
};

document.getElementById("estado").innerHTML="Escaneo terminado ✔";

document.getElementById("datos").innerHTML=
"===== DATOS DETECTADOS =====\n\n"+
"No. Servicio: "+datos.numeroServicio+"\n\n"+
"Periodo: "+datos.periodo+"\n\n"+
"Consumo: "+datos.consumo+"\n\n"+
"Total: "+datos.total;

document.getElementById("textoOCR").innerHTML=
"\n\n===== TEXTO COMPLETO OCR =====\n\n"+text;

}

</script>

</body>
</html>
