<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Escáner Inteligente CFE</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
</script>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
h1{text-align:center}
.card{
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}
button{padding:6px;margin-top:5px}
input{width:100%;margin-top:5px;padding:5px}
</style>
</head>

<body>

<h1>Escáner Inteligente CFE</h1>

<input type="file" id="fileInput" accept="image/*,.pdf">
<button onclick="procesar()">Escanear</button>

<h2>Registros</h2>
<div id="contenedor"></div>

<script>

let registros = JSON.parse(localStorage.getItem("registros")) || [];
let patrones  = JSON.parse(localStorage.getItem("patrones")) || {};

mostrar();

async function procesar(){

  const file = document.getElementById("fileInput").files[0];
  if(!file){
    alert("Selecciona archivo");
    return;
  }

  if(file.type === "application/pdf"){

    const reader = new FileReader();
    reader.onload = async () => {

      const typedarray = new Uint8Array(reader.result);
      const pdf = await pdfjsLib.getDocument(typedarray).promise;

      let textoCompleto = "";

      for(let p=1; p<=pdf.numPages; p++){

        const page = await pdf.getPage(p);

        const viewport = page.getViewport({scale:2});
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        canvas.width  = viewport.width;
        canvas.height = viewport.height;

        await page.render({canvasContext:context, viewport}).promise;

        const result = await Tesseract.recognize(canvas,'spa');
        textoCompleto += "\n" + result.data.text;
      }

      let limpio = limpiarTexto(textoCompleto);
      let datos  = extraerDatos(limpio);

      guardarRegistro(limpio, datos);
    };

    reader.readAsArrayBuffer(file);

  }else{

    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.src = reader.result;
      img.onload = () => escanear(img);
    };
    reader.readAsDataURL(file);

  }
}

async function escanear(img){

  const result = await Tesseract.recognize(
    img,
    'spa'
  );

  let texto = result.data.text;

  let limpio = limpiarTexto(texto);
  let datos  = extraerDatos(limpio);

  guardarRegistro(limpio, datos);
}

function limpiarTexto(texto){

  texto = texto.replace(/Totai/gi,"Total");
  texto = texto.replace(/Paqar/gi,"Pagar");
  texto = texto.replace(/O/g,"0");

  return texto;
}

/* ===========================
   EXTRACCIÓN DE DATOS CFE
   =========================== */

function extraerDatos(texto){

  const nds = detectarNombreDireccionServicio(texto);

  return {
    nombre: nds.nombre,
    direccion: nds.direccion,
    servicio: nds.servicio,

    limitePago: detectarLimitePago(texto),
    corteApartir: detectarCorte(texto),

    tarifa: detectarTarifa(texto),
    medidor: detectarMedidor(texto),
    multiplicador: detectarMultiplicador(texto),

    periodo: detectarPeriodo(texto),
    total: detectarTotal(texto),
    energia: detectarEnergia(texto)
  };
}

/* nombre arriba de dirección y dirección arriba de servicio */

function detectarNombreDireccionServicio(texto){

  let lineas = texto
    .split('\n')
    .map(l => l.trim())
    .filter(l => l.length > 0);

  let idx = lineas.findIndex(l =>
    /no\.?\s*servicio|servicio|rpu/i.test(l)
  );

  let servicio  = "No detectado";
  let direccion = "No detectado";
  let nombre    = "No detectado";

  if(idx !== -1){

    let m = lineas[idx].match(/([0-9]{6,})/);
    if(m) servicio = m[1];

    if(idx-1 >= 0) direccion = lineas[idx-1];
    if(idx-2 >= 0) nombre    = lineas[idx-2];
  }

  return {nombre, direccion, servicio};
}

function detectarLimitePago(texto){
  let m = texto.match(/l[ií]mite\s*de\s*pago\s*[:\-]?\s*([^\n]+)/i);
  return m ? m[1].trim() : "No detectado";
}

function detectarCorte(texto){
  let m = texto.match(/corte\s*a\s*partir\s*[:\-]?\s*([^\n]+)/i);
  return m ? m[1].trim() : "No detectado";
}

function detectarTarifa(texto){
  let m = texto.match(/tarifa\s*[:\-]?\s*([A-Z0-9]+)/i);
  return m ? m[1] : "No detectado";
}

function detectarMedidor(texto){
  let m = texto.match(/medidor\s*[:\-]?\s*([0-9]+)/i);
  return m ? m[1] : "No detectado";
}

function detectarMultiplicador(texto){
  let m = texto.match(/multiplicador\s*[:\-]?\s*([0-9.,]+)/i);
  return m ? m[1] : "No detectado";
}

function detectarPeriodo(texto){
  let m = texto.match(/periodo\s*(facturado)?\s*[:\-]?\s*([^\n]+)/i);
  return m ? m[2].trim() : "No detectado";
}

function detectarTotal(texto){
  let m = texto.match(/(total\s*a\s*pagar|importe\s*a\s*pagar)\s*[$]?\s*([0-9.,]+)/i);
  return m ? m[2] : "No detectado";
}

function detectarEnergia(texto){
  let m = texto.match(/energ[ií]a\s*(en)?\s*kwh\s*[:\-]?\s*([0-9.,]+)/i);
  return m ? m[2] : "No detectado";
}

/* =========================== */

function guardarRegistro(texto,datos){
  registros.push({texto,datos});
  localStorage.setItem("registros",JSON.stringify(registros));
  mostrar();
}

function mostrar(){

  const cont = document.getElementById("contenedor");
  cont.innerHTML = "";

  registros.forEach((r,i)=>{

    cont.innerHTML += `
    <div class="card">

      <b>Nombre</b>
      <input value="${r.datos.nombre}" onchange="editar(${i},'nombre',this.value)">

      <b>Dirección</b>
      <input value="${r.datos.direccion}" onchange="editar(${i},'direccion',this.value)">

      <b>No. servicio</b>
      <input value="${r.datos.servicio}" onchange="editar(${i},'servicio',this.value)">

      <b>Límite de pago</b>
      <input value="${r.datos.limitePago}" onchange="editar(${i},'limitePago',this.value)">

      <b>Corte a partir</b>
      <input value="${r.datos.corteApartir}" onchange="editar(${i},'corteApartir',this.value)">

      <b>Tarifa</b>
      <input value="${r.datos.tarifa}" onchange="editar(${i},'tarifa',this.value)">

      <b>No. medidor</b>
      <input value="${r.datos.medidor}" onchange="editar(${i},'medidor',this.value)">

      <b>Multiplicador</b>
      <input value="${r.datos.multiplicador}" onchange="editar(${i},'multiplicador',this.value)">

      <b>Periodo facturado</b>
      <input value="${r.datos.periodo}" onchange="editar(${i},'periodo',this.value)">

      <b>Total a pagar</b>
      <input value="${r.datos.total}" onchange="editar(${i},'total',this.value)">

      <b>Energía (kWh)</b>
      <input value="${r.datos.energia}" onchange="editar(${i},'energia',this.value)">

      <button onclick="verTexto(${i})">Ver texto OCR</button>
      <button onclick="borrar(${i})">Borrar</button>
    </div>
    `;
  });
}

function editar(index,campo,valor){

  registros[index].datos[campo] = valor;
  aprender(registros[index].texto, campo, valor);

  localStorage.setItem("registros",JSON.stringify(registros));
}

function aprender(texto,campo,valor){
  if(valor !== "No detectado" && valor.trim() !== ""){
    patrones[campo] = campo + "[:\\s]*(" + valor + ")";
    localStorage.setItem("patrones",JSON.stringify(patrones));
  }
}

function verTexto(i){
  alert(registros[i].texto);
}

function borrar(i){
  registros.splice(i,1);
  localStorage.setItem("registros",JSON.stringify(registros));
  mostrar();
}

</script>

</body>
</html>
