<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Escáner Inteligente CFE</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
</script>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
h1{text-align:center}
.card{
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}
button{padding:6px;margin-top:5px}
textarea{width:100%;height:120px;margin-top:10px}
input{width:100%;margin-top:5px;padding:5px}
</style>
</head>

<body>

<h1>Escáner Inteligente CFE</h1>

<input type="file" id="fileInput" accept="image/*,.pdf">
<button onclick="procesar()">Escanear</button>

<h2>Registros</h2>
<div id="contenedor"></div>

<script>

let registros = JSON.parse(localStorage.getItem("registros")) || [];
let patrones = JSON.parse(localStorage.getItem("patrones")) || {};

mostrar();

async function procesar(){

  const file = document.getElementById("fileInput").files[0];
  if(!file){
    alert("Selecciona archivo");
    return;
  }

  if(file.type === "application/pdf"){

    const reader = new FileReader();
    reader.onload = async () => {

      const typedarray = new Uint8Array(reader.result);
      const pdf = await pdfjsLib.getDocument(typedarray).promise;

      /* ========= CAMBIO 1: leer todas las páginas ========= */

      let textoCompleto = "";

      for(let p = 1; p <= pdf.numPages; p++){

        const page = await pdf.getPage(p);

        const viewport = page.getViewport({scale:2});
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({canvasContext:context, viewport}).promise;

        const result = await Tesseract.recognize(
          canvas,
          'spa'
        );

        textoCompleto += "\n" + result.data.text;
      }

      let limpio = limpiarTexto(textoCompleto);
      let datos  = extraerDatos(limpio);

      guardarRegistro(limpio, datos);

      /* =================================================== */

    };

    reader.readAsArrayBuffer(file);

  }else{

    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.src = reader.result;
      img.onload = () => escanear(img);
    };
    reader.readAsDataURL(file);

  }
}

async function escanear(img){

  alert("Escaneando...");

  const result = await Tesseract.recognize(
    img,
    'spa',
    { logger: m => console.log(m) }
  );

  let texto = result.data.text;

  let limpio = limpiarTexto(texto);
  let datos = extraerDatos(limpio);

  guardarRegistro(limpio, datos);
}

function limpiarTexto(texto){

  texto = texto.replace(/Totai/gi,"Total");
  texto = texto.replace(/Paqar/gi,"Pagar");
  texto = texto.replace(/O/g,"0");

  return texto;
}

/* =============================
   DETECTORES PARA RECIBO CFE
   ============================= */

function extraerDatos(texto){

  let datos = {
    nombre: detectarNombre(texto),
    servicio: detectarServicio(texto),
    total: detectarTotal(texto),
    direccion: detectarDireccion(texto),
    periodo: detectarPeriodo(texto)
  };

  return datos;
}

/* ========= CAMBIO 2: detectarTotal ========= */

function detectarTotal(texto){
  let m = texto.match(/(importe\s*a\s*pagar|total)\s*[$]?\s*([0-9.,]+)/i);
  return m ? m[2] : "No detectado";
}

function detectarServicio(texto){
  let m = texto.match(/(servicio|rpu)\s*[:#]?\s*([0-9]+)/i);
  return m ? m[2] : "No detectado";
}

function detectarPeriodo(texto){
  let m = texto.match(/periodo\s*[:\-]?\s*([^\n]+)/i);
  return m ? m[1].trim() : "No detectado";
}

function detectarNombre(texto){
  let m = texto.match(/nombre\s*[:\-]?\s*([^\n]+)/i);
  return m ? m[1].trim() : "No detectado";
}

function detectarDireccion(texto){
  let m = texto.match(/(domicilio|direcci[oó]n)\s*[:\-]?\s*([^\n]+)/i);
  return m ? m[2].trim() : "No detectado";
}

/* ============================= */

function guardarRegistro(texto,datos){

  registros.push({texto,datos});
  localStorage.setItem("registros",JSON.stringify(registros));
  mostrar();
}

function mostrar(){

  const cont = document.getElementById("contenedor");
  cont.innerHTML = "";

  registros.forEach((r,i)=>{

    cont.innerHTML += `
    <div class="card">
      <b>Nombre:</b>
      <input value="${r.datos.nombre}" onchange="editar(${i},'nombre',this.value)">

      <b>Servicio:</b>
      <input value="${r.datos.servicio}" onchange="editar(${i},'servicio',this.value)">

      <b>Total:</b>
      <input value="${r.datos.total}" onchange="editar(${i},'total',this.value)">

      <b>Dirección:</b>
      <input value="${r.datos.direccion}" onchange="editar(${i},'direccion',this.value)">

      <b>Periodo:</b>
      <input value="${r.datos.periodo}" onchange="editar(${i},'periodo',this.value)">

      <button onclick="verTexto(${i})">Ver texto OCR</button>
      <button onclick="borrar(${i})">Borrar</button>
    </div>
    `;
  });
}

function editar(index,campo,valor){

  registros[index].datos[campo] = valor;
  aprender(registros[index].texto, campo, valor);

  localStorage.setItem("registros",JSON.stringify(registros));
}

function aprender(texto,campo,valor){

  if(valor !== "No detectado" && valor.trim() !== ""){
    patrones[campo] = campo + "[:\\s]*(" + valor + ")";
    localStorage.setItem("patrones",JSON.stringify(patrones));
  }
}

function verTexto(i){
  alert(registros[i].texto);
}

function borrar(i){
  registros.splice(i,1);
  localStorage.setItem("registros",JSON.stringify(registros));
  mostrar();
}

</script>

</body>
</html>
